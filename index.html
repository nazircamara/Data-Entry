<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Registration System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Removed external Google Fonts to support offline usage -->
<style>
:root{
  --bg: #0f172a;
  --card: #1e293b;
  --text: #f8fafc;
  --text-dim: #94a3b8;
  --accent: #6366f1;
  --accent-hover: #818cf8;
  --border: #334155;
  --danger: #f43f5e;
  --success: #10b981;
}

*{box-sizing:border-box; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;}

body{
  margin:0;
  background-color: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

.container{
  max-width: 1000px;
  margin: auto;
  padding: 24px;
}

.header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 15px;
}

h2, h3 { font-weight: 600; margin: 0; color: var(--text); }

.card{
  background: var(--card);
  border-radius: 16px;
  padding: 24px;
  margin-top: 20px;
  border: 1px solid var(--border);
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

button{
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: var(--accent);
  color: #fff;
  font-weight: 500;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

button:hover{ background: var(--accent-hover); transform: translateY(-1px); }

input, select {
  padding: 12px 16px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #0f172a;
  color: var(--text);
  font-size: 14px;
  outline: none;
}

/* IMPROVED GRADE MANAGER LAYOUT */
.grade-manager {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.grade-manager .input-group {
    display: flex;
    gap: 8px;
    flex-grow: 1;
}

#fieldList { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }

.field-chip {
  background: rgba(99, 102, 241, 0.15);
  color: #a5b4fc;
  border: 1px solid rgba(99, 102, 241, 0.3);
  padding: 6px 14px;
  border-radius: 100px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.field-chip span { cursor: pointer; color: var(--danger); font-size: 16px; }

form{ display: grid; gap: 16px; }
@media(min-width:768px){ form{ grid-template-columns: 1fr 1fr; } }

.primary{ grid-column: 1/-1; background: var(--success); justify-content: center; }
.primary:hover{ background: #059669; }

.table-controls {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 20px;
  align-items: center;
}

/* FIX FOR BUTTON ALIGNMENT */
[dir="rtl"] #btnClear { margin-right: auto; margin-left: 0; }
[dir="ltr"] #btnClear { margin-left: auto; margin-right: 0; }

.table-container { width: 100%; overflow-x: auto; margin-top: 20px; border-radius: 8px; }

table{ width: 100%; border-collapse: collapse; font-size: 14px; min-width: 600px; }

th{
  background: rgba(15, 23, 42, 0.5);
  color: var(--text-dim);
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.05em;
  padding: 16px;
  text-align: inherit;
}

td{ padding: 16px; border-bottom: 1px solid var(--border); }

@media print{
  body{ background: white; color: black; }
  .card{ border: none; box-shadow: none; }
  .table-container, .table-container *{ visibility: visible; }
}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <h2 id="title">üéì Student Registration</h2>
  <button onclick="toggleLang()" style="background: transparent; border: 1px solid var(--border);">üåç Language</button>
</div>

<div class="card">
  <h3 id="gradeTitle" style="margin-bottom:15px">üìÇ Current Grade / Level</h3>
  <div class="grade-manager">
    <div style="display:flex; gap:8px; align-items:center;">
        <select id="gradeSelect" onchange="switchGrade()"></select>
        <button onclick="deleteGrade()" id="btnDelGrade" style="background:var(--danger); padding: 10px 12px;" title="Delete Current Grade">üóë</button>
    </div>
    <div class="input-group">
        <input id="newGradeName" style="flex:1" placeholder="e.g. Grade 10">
        <button onclick="addGrade()" id="btnAddGrade">Ôºã New Grade</button>
    </div>
  </div>
</div>

<div class="card">
  <h3 id="setupTitle">‚öôÔ∏è Form Fields</h3>
  <div style="display:flex; gap:12px; margin-top:15px">
    <input id="newField" style="flex:1" placeholder="Add a field">
    <button id="addFieldBtn" onclick="addField()">Add</button>
  </div>
  <div id="fieldList"></div>
</div>

<div class="card">
  <form id="form"></form>
</div>

<div class="card">
  <h3 id="recordsTitle" style="margin-bottom:15px">üìã Registered Students</h3>
  
  <input type="text" id="searchInput" class="search-input" onkeyup="searchRecords()" 
         placeholder="üîç Search entries..." style="width:100%; margin-bottom:15px; border-width: 2px;">

  <div class="table-controls">
    <button id="btnExport" onclick="exportCSV()" style="background:#475569">üìÑ Excel</button>
    <button id="btnClear" onclick="clearData()" style="background:var(--danger)">üóë Clear Grade</button>
  </div>

  <div class="table-container">
    <table id="table">
      <thead><tr id="thead"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

</div>

<script>
/* GLOBAL STATE */
let lang = localStorage.getItem("lang") || "en";
let grades = JSON.parse(localStorage.getItem("grades")) || ["Grade 1"];
let currentGrade = localStorage.getItem("currentGrade") || "Grade 1";

if (!grades.includes(currentGrade)) {
    currentGrade = grades[0];
    localStorage.setItem("currentGrade", currentGrade);
}

let fields = JSON.parse(localStorage.getItem(`fields_${currentGrade}`)) || ["Full Name","Email"];
let data = JSON.parse(localStorage.getItem(`data_${currentGrade}`)) || [];

const form = document.getElementById("form");
const thead = document.getElementById("thead");
const tbody = document.getElementById("tbody");

const i18n = {
  en: {
    title: "üéì Student Registration",
    gradeTitle: "üìÇ Current Grade / Level",
    setup: "‚öôÔ∏è Form Fields",
    records: "üìã Registered Students",
    addField: "Add",
    newGrade: "Ôºã New Grade",
    print: "üñ® Print",
    export: "üìÑ Excel",
    clear: "üóë Clear Grade",
    placeholderGrade: "e.g. Grade 10",
    placeholderField: "Add a field",
    register: "Complete Registration",
    confirmClear: "Delete all records for this grade?",
    confirmDeleteField: "Delete this field?",
    confirmDeleteGrade: "Delete the ENTIRE grade and all its students? This cannot be undone.",
    searchPlaceholder: "üîç Search entries...",
    time: "Time"
  },
  ar: {
    title: "üéì ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ∑ŸÑÿßÿ®",
    gradeTitle: "üìÇ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© / ÿßŸÑÿµŸÅ ÿßŸÑÿ≠ÿßŸÑŸä",
    setup: "‚öôÔ∏è ÿ≠ŸÇŸàŸÑ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨",
    records: "üìã ÿßŸÑÿ∑ŸÑÿßÿ® ÿßŸÑŸÖÿ≥ÿ¨ŸÑŸäŸÜ",
    addField: "ÿ•ÿ∂ÿßŸÅÿ©",
    newGrade: "ÿµŸÅ ÿ¨ÿØŸäÿØ Ôºã",
    print: "üñ® ÿ∑ÿ®ÿßÿπÿ©",
    export: "üìÑ ÿ•ŸÉÿ≥ŸÑ",
    clear: "üóë ŸÖÿ≥ÿ≠ ÿßŸÑÿµŸÅ",
    placeholderGrade: "ŸÖÿ´ŸÑÿßŸã: ÿßŸÑÿµŸÅ 10",
    placeholderField: "ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ŸÇŸÑ",
    register: "ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ",
    confirmClear: "ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ŸÑŸáÿ∞ÿß ÿßŸÑÿµŸÅÿü",
    confirmDeleteField: "ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≠ŸÇŸÑÿü",
    confirmDeleteGrade: "ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿµŸÅ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿ∑ŸÑÿßÿ®Ÿáÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.",
    searchPlaceholder: "üîç ÿ®ÿ≠ÿ´...",
    time: "Time"
  }
};

/* GRADE MANAGEMENT */
function updateGradeDropdown() {
  const select = document.getElementById("gradeSelect");
  select.innerHTML = grades.map(g => `<option value="${g}" ${g === currentGrade ? 'selected' : ''}>${g}</option>`).join("");
}

function addGrade() {
  const name = document.getElementById("newGradeName").value.trim();
  if(!name || grades.includes(name)) return;
  grades.push(name);
  localStorage.setItem("grades", JSON.stringify(grades));
  currentGrade = name;
  localStorage.setItem("currentGrade", currentGrade);
  location.reload();
}

function switchGrade() {
  currentGrade = document.getElementById("gradeSelect").value;
  localStorage.setItem("currentGrade", currentGrade);
  location.reload();
}

function deleteGrade() {
    if (grades.length <= 1) return alert("You must have at least one grade.");
    if (confirm(i18n[lang].confirmDeleteGrade)) {
        localStorage.removeItem(`fields_${currentGrade}`);
        localStorage.removeItem(`data_${currentGrade}`);
        grades = grades.filter(g => g !== currentGrade);
        localStorage.setItem("grades", JSON.stringify(grades));
        currentGrade = grades[0];
        localStorage.setItem("currentGrade", currentGrade);
        location.reload();
    }
}

function getEnglishTimestamp() {
  const now = new Date();
  const day = String(now.getDate()).padStart(2, '0');
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const year = now.getFullYear();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  return `${day}/${month}/${year} ${h}:${m}`;
}

function init() {
  applyLang();
  updateGradeDropdown();
  renderFieldList();
  renderForm();
  renderTable();
  refreshAllRows();
}

function renderFieldList() {
  const list = document.getElementById("fieldList");
  list.innerHTML = "";
  fields.forEach((f, index) => {
    const chip = document.createElement("div");
    chip.className = "field-chip";
    chip.innerHTML = `${f} <span onclick="deleteField(${index})">&times;</span>`;
    list.appendChild(chip);
  });
}

function addField(){
  const input = document.getElementById("newField");
  if(!input.value) return;
  fields.push(input.value);
  data.forEach(row => row.values.push(""));
  save();
  input.value="";
  init();
}

function deleteField(index) {
  if(confirm(i18n[lang].confirmDeleteField)) {
    fields.splice(index, 1);
    data.forEach(row => row.values.splice(index, 1));
    save();
    init();
  }
}

function renderForm(){
  form.innerHTML="";
  fields.forEach(f=>{
    const input = document.createElement("input");
    input.placeholder = f;
    input.required = true;
    form.appendChild(input);
  });
  const btn = document.createElement("button");
  btn.className = "primary";
  btn.innerText = i18n[lang].register;
  form.appendChild(btn);
}

form.onsubmit = e => {
  e.preventDefault();
  const values = [...form.querySelectorAll("input")].map(i => i.value);
  data.push({ values, time: getEnglishTimestamp() });
  save();
  addRow(data[data.length-1], data.length-1);
  form.reset();
};

function renderTable(){
  thead.innerHTML=`<th>#</th>` + 
                  fields.map(f=>`<th>${f}</th>`).join("") + 
                  `<th>${i18n[lang].time}</th>`;
  tbody.innerHTML="";
}

function addRow(row, index){
  const tr = tbody.insertRow();
  tr.innerHTML = `<td>${index + 1}</td>`;
  row.values.forEach((v, vIdx) => {
    const td = document.createElement("td");
    td.contentEditable = true;
    td.innerText = v;
    td.oninput = () => { data[index].values[vIdx] = td.innerText; save(); };
    tr.appendChild(td);
  });
  tr.innerHTML += `<td>${row.time}</td>`;
}

function refreshAllRows() {
  tbody.innerHTML = "";
  data.forEach((row, index) => addRow(row, index));
}

function searchRecords() {
    const term = document.getElementById("searchInput").value.toLowerCase();
    for (let row of tbody.rows) {
        row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none";
    }
}

function save(){ 
  localStorage.setItem(`fields_${currentGrade}`, JSON.stringify(fields));
  localStorage.setItem(`data_${currentGrade}`, JSON.stringify(data));
}

function exportCSV(){
  let csv = "\uFEFF" + fields.join(",") + ",Time\n";
  data.forEach(row => {
    csv += row.values.map(v => `"${v}"`).join(",") + `,"${row.time}"\n`;
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8;"}));
  a.download = `${currentGrade}_list.csv`;
  a.click();
}

function clearData(){
  if(confirm(i18n[lang].confirmClear)){
    data = [];
    save();
    refreshAllRows();
  }
}

function toggleLang(){
  lang = lang === "en" ? "ar" : "en";
  localStorage.setItem("lang", lang);
  applyLang();
}

function applyLang(){
  const t = i18n[lang];
  document.documentElement.dir = lang === "ar" ? "rtl" : "ltr";
  document.getElementById("title").innerText = t.title;
  document.getElementById("gradeTitle").innerText = t.gradeTitle;
  document.getElementById("setupTitle").innerText = t.setup;
  document.getElementById("recordsTitle").innerText = t.records;
  document.getElementById("addFieldBtn").innerText = t.addField;
  document.getElementById("btnAddGrade").innerText = t.newGrade;
  document.getElementById("newGradeName").placeholder = t.placeholderGrade;
  document.getElementById("newField").placeholder = t.placeholderField;
  const btnPrintEl = document.getElementById("btnPrint");
  if (btnPrintEl) btnPrintEl.innerText = t.print;
  document.getElementById("btnExport").innerText = t.export;
  document.getElementById("btnClear").innerText = t.clear;
  document.getElementById("searchInput").placeholder = t.searchPlaceholder;
  renderForm();
  renderTable();
  refreshAllRows();
}



init();
</script>
</body>
</html>